// আপনার দেওয়া Firebase কনফিগারেশন
const firebaseConfig = {
    apiKey: "AIzaSyBVz9mxIL8rD8s2IHZrGcihO9uYCfu2Zgg",
    authDomain: "crash-an-egg.firebaseapp.com",
    databaseURL: "https://crash-an-egg-default-rtdb.firebaseio.com",
    projectId: "crash-an-egg",
    storageBucket: "crash-an-egg.appspot.com", // .firebasestorage.app পরিবর্তিত হয়ে .appspot.com হতে পারে
    messagingSenderId: "675612863279",
    appId: "1:675612863279:web:7e384a59ee3e97c0258fda",
    measurementId: "G-EYSLPZ2B19"
};

// Firebase শুরু করুন
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// টেলিগ্রাম মিনি অ্যাপ SDK শুরু করুন
const tg = window.Telegram.WebApp;
tg.ready();

// HTML এলিমেন্টগুলো সিলেক্ট করুন
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const gameContainer = document.getElementById('game-container');
const walletContainer = document.getElementById('wallet-container');
const gameBtn = document.getElementById('game-btn');
const showAdsBtn = document.getElementById('show-ads-btn');
const walletBtn = document.getElementById('wallet-btn');
const withdrawBtn = document.getElementById('withdraw-btn');
const coinBalanceSpan = document.getElementById('coin-balance');
const withdrawAmountInput = document.getElementById('withdraw-amount');

// ব্যবহারকারীর আইডি পান
const userId = tg.initDataUnsafe?.user?.id || 'testuser123'; // পরীক্ষার জন্য একটি ডিফল্ট আইডি

// গেমের ভ্যারিয়েবল
const gridSize = 20;
let snake = [{ x: 10, y: 10 }];
let food = {};
let dx = 1;
let dy = 0;
let changingDirection = false;
let gameRunning = false;
let score = 0;

// ব্যবহারকারীর ডেটা এবং ওয়ালেট ফাংশন
function getUserData() {
    database.ref('users/' + userId).on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && data.coins !== undefined) {
            coinBalanceSpan.textContent = data.coins;
        } else {
            // নতুন ব্যবহারকারী হলে ডেটাবেসে এন্ট্রি তৈরি করুন
            database.ref('users/' + userId).set({ coins: 0 });
            coinBalanceSpan.textContent = 0;
        }
    });
}

function addCoins(amount) {
    const userRef = database.ref('users/' + userId);
    userRef.transaction((currentUser) => {
        if (currentUser) {
            currentUser.coins = (currentUser.coins || 0) + amount;
        }
        return currentUser;
    });
}

// বিজ্ঞাপন দেখানোর ফাংশন
function showAd() {
    // গুরুত্বপূর্ণ: এখানে আপনার Ad Network এর SDK কোড যুক্ত করতে হবে।
    // নিচের কোডটি শুধুমাত্র একটি নমুনা।
    console.log("Showing Ad...");
    tg.showPopup({
        title: 'Advertisement',
        message: 'You are watching an ad. You will receive 10 coins after it finishes.',
        buttons: [{
            text: 'Close Ad',
            type: 'ok',
        }]
    }, () => {
        // বিজ্ঞাপন দেখা শেষ হলে এই ফাংশনটি কল হবে
        adFinished();
    });
}

function adFinished() {
    addCoins(10);
    tg.showAlert("Congratulations! You've earned 10 coins!");
}

// গেম ফাংশন
function drawRect(x, y, color) {
    ctx.fillStyle = color;
    ctx.fillRect(x * gridSize, y * gridSize, gridSize, gridSize);
}

function drawSnake() {
    snake.forEach((part, index) => {
        const color = index === 0 ? 'green' : 'lightgreen';
        drawRect(part.x, part.y, color);
    });
}

function generateFood() {
    food = {
        x: Math.floor(Math.random() * (canvas.width / gridSize)),
        y: Math.floor(Math.random() * (canvas.height / gridSize))
    };
    // নিশ্চিত করুন খাবার সাপের দেহের উপর তৈরি না হয়
    snake.forEach(part => {
        if (part.x === food.x && part.y === food.y) {
            generateFood();
        }
    });
}

function drawFood() {
    drawRect(food.x, food.y, 'red');
}

function advanceSnake() {
    const head = { x: snake[0].x + dx, y: snake[0].y + dy };
    snake.unshift(head);

    if (head.x === food.x && head.y === food.y) {
        score += 10;
        addCoins(1); // গেম খেলার জন্য ১ কয়েন
        generateFood();
    } else {
        snake.pop();
    }
}

function didGameEnd() {
    // দেয়ালের সাথে সংঘর্ষ
    if (snake[0].x < 0 || snake[0].x >= canvas.width / gridSize ||
        snake[0].y < 0 || snake[0].y >= canvas.height / gridSize) {
        return true;
    }
    // নিজের দেহের সাথে সংঘর্ষ
    for (let i = 4; i < snake.length; i++) {
        if (snake[i].x === snake[0].x && snake[i].y === snake[0].y) {
            return true;
        }
    }
    return false;
}

function changeDirection(event) {
    if (changingDirection) return;
    changingDirection = true;

    const keyPressed = event.keyCode;
    const goingUp = dy === -1;
    const goingDown = dy === 1;
    const goingRight = dx === 1;
    const goingLeft = dx === -1;

    if (keyPressed === 37 && !goingRight) { dx = -1; dy = 0; } // Left
    if (keyPressed === 38 && !goingDown) { dx = 0; dy = -1; } // Up
    if (keyPressed === 39 && !goingLeft) { dx = 1; dy = 0; } // Right
    if (keyPressed === 40 && !goingUp) { dx = 0; dy = 1; } // Down
}

function gameLoop() {
    if (!gameRunning) return;
    if (didGameEnd()) {
        gameRunning = false;
        tg.showAlert(`Game Over! Your score: ${score}. Watch an ad for a bonus!`);
        showAd();
        return;
    }

    changingDirection = false;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawFood();
    advanceSnake();
    drawSnake();
}

function startGame() {
    snake = [{ x: 10, y: 10 }];
    dx = 1;
    dy = 0;
    score = 0;
    generateFood();
    gameRunning = true;
    setInterval(gameLoop, 100);
}

// বোতামের ইভেন্ট লিসেনার
showAdsBtn.addEventListener('click', showAd);

gameBtn.addEventListener('click', () => {
    walletContainer.style.display = 'none';
    gameContainer.style.display = 'block';
    if (!gameRunning) {
        startGame();
    }
});

walletBtn.addEventListener('click', () => {
    gameContainer.style.display = 'none';
    walletContainer.style.display = 'block';
    gameRunning = false; // ওয়ালেট দেখার সময় গেম বন্ধ করুন
});

withdrawBtn.addEventListener('click', () => {
    const amount = parseInt(withdrawAmountInput.value);
    const currentCoins = parseInt(coinBalanceSpan.textContent);

    if (!amount || amount < 10000) {
        tg.showAlert("Minimum withdraw amount is 10000 coins.");
        return;
    }

    if (amount > currentCoins) {
        tg.showAlert("Insufficient balance.");
        return;
    }

    // টাকা তোলার অনুরোধ ডেটাবেসে সংরক্ষণ করুন
    const withdrawRef = database.ref('withdrawals/' + userId).push();
    withdrawRef.set({
        amount: amount,
        method: 'Bkash',
        status: 'pending',
        timestamp: Date.now()
    }).then(() => {
        // ব্যবহারকারীর কয়েন থেকে পরিমাণটি বাদ দিন
        const userRef = database.ref('users/' + userId);
        userRef.update({ coins: currentCoins - amount });

        tg.showAlert(`Your withdrawal request for ${amount} coins to Bkash has been submitted successfully!`);
        withdrawAmountInput.value = '';
    }).catch(error => {
        tg.showAlert('Something went wrong. Please try again.');
        console.error("Withdraw error: ", error);
    });
});

document.addEventListener('keydown', changeDirection);

// অ্যাপ শুরু হলে যা যা হবে
getUserData();
startGame();
